---
title: "Data Persistence using SQL in EPIC"
author: "John Chapman"
date: "11/11/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Overview for data persistence goal:
1. Select dev server
2. Install sqlite (mysql?)
3. Transfer data to sql
  + transfer Master1 
  + cip1
  + soc1
4. Alter any code?

.. Replicate master branch using sql input/output


# Select Dev Server

* WelcomeU - to separate production from dev.  But, would mean double the maintenance/upgrades. But prob better development vs production app management.
+ What needs to happen to make Welcome U the dev server?
++ R installed - check
++ Shiny installed - check
++ git installed - check
++ install ssh public key to login from ipad

# Install Sqlite or MySQL
* SQLite is probably a sufficient sql engine for the number of users we expect and to avoid the upkeep of MySQL
+ sudo su - -c "R -e \"install.packages('RSQLite', repos='http://cran.rstudio.com/')\""

# Transfer data to sql
* copied epicdb.sqlite file from Dropbox/R-Studio/EPIC-old/data

## 2019 11 11 - first run app() results:
> Listening on http://127.0.0.1:4886  
> Warning: Error in %in%: object 'school.name' not found

Need to check on school.name field, did it transfer ok?  Is it newer than the epicdb.sqlite file? Do I need to create a new epicdb.sqlite database?  
Also need to create or tables for the soc and cip

2019 11 11 13:39 - re-imported the csv file from the zip file into sqlite, and the app runs great.
Had to use Epic username to get in
So, success in loading the master1 file
Let me move on to SOC, CIP - added these as separate tables within the database

Need to know what the user_data structure is to capture user preferences
### User data table
<!-- Sources -->
<!-- https://github.com/datastorm-open/shinymanager -->
<!-- https://github.com/paulc91/shinyauthr -->

acct_id: user id
user_name: login name
user_password: login password
acct_admin: "no" or "yes"
acct_email: email address
acct_created: date-time of creation

Successfully wrote to db using following code:

```{r}


 data_test <- data.frame(
   acct_first_last = "John Chapman",
   user_name = "Juancito",
   user_password = sapply("pass1",password_store),
   acct_email = "juancito@benitosburritos.com",
   acct_admin = "No",
   acct_created = as.character(Sys.time()),
  stringsAsFactors = FALSE
 )

sqlitePath <- "data/epic_20191111.sqlite"

db <- dbConnect(SQLite(), sqlitePath)
dbWriteTable(db,"accounts", data_test, append = TRUE)

# check results ----
dbListTables(db)
dbGetQuery(db, "SELECT * FROM accounts")

```

Next step: Try to insert user from the Create Account popup 


Wait a minute ... what about google authentication?  Isn't this better than creating our own authentication? In terms of updating passwords, hashing passwords, security, resetting?  
```{r}
library(googleAuthR)
# starts auth process with defaults
gar_auth()
#>The googleAuthR package is requesting access to your Google account. Select a 
#> pre-authorised account or enter '0' to obtain a new token. Press Esc/Ctrl + C to abort.

#> 1: mark@work.com
#> 2: home@home.com
```

